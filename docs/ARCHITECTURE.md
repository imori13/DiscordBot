# アーキテクチャ設計

## システム構成

```
                    +---------------------+
                    |                     |
  +----------+      |     Discord Bot     |      +------------+
  |          |      |    (TypeScript)     |      |            |
  |  Trello  +------+                     +------+  Discord   |
  |   API    |      | +---------------+   |      |  サーバー   |
  |          |      | | コマンドハンドラ |   |      |            |
  +----------+      | +-------+-------+   |      +------------+
                    |         |           |
                    +---------------------+
                              |
              +---------------+---------------+
              |                               |
    +---------v---------+           +---------v---------+
    |  設定管理システム   |           |   通知管理システム  |
    | (ボード選択・保存)  |           | (ポーリング・フィルタ) |
    +---------+---------+           +---------+---------+
              |                               |
              |                               |
    +---------v---------+                     |
    |    永続化ストレージ  |                     |
    |  (Docker Volume)  |                     |
    +-------------------+                     |
```

## レイヤー構造

```
+-----------------------------------+
|           プレゼンテーション層           |
|  - Discord インタラクション            |
|  - スラッシュコマンドハンドラ            |
+-----------------------------------+
|             サービス層               |
|  - Trello API クライアント           |
|  - ボード管理サービス                 |
|  - 通知サービス                     |
+-----------------------------------+
|             データ層                |
|  - 設定ファイル管理                  |
|  - Docker ボリューム                |
+-----------------------------------+
```

## コンポーネント設計

### 1. Botコア (bot.ts)

- Discord接続管理
- イベントハンドリング
- コマンド登録
- スケジューリング

### 2. コマンドシステム (commands.ts, commands/*)

- コマンド定義
- コマンドハンドラ
- ヘルプ機能
- オートコンプリート

### 3. Trello連携 (trello-api.ts)

- API呼び出し
- データ型定義
- エラーハンドリング

### 4. ボード管理 (trello-boards.ts)

- 利用可能なボード一覧取得
- アクティブボード選択
- 設定の永続化

### 5. 通知システム (bot.ts内)

- ポーリング
- 通知フィルタリング
- フォーマット変換
- 送信処理

## Docker構成

```
+---------------------------------------------------------------+
|                       Docker コンテナ                           |
|                                                               |
|  +----------------------------+  +------------------------+   |
|  |       Node.js アプリ        |  |     ヘルスチェック       |   |
|  |  (TypeScript/JavaScript)   |  |  (HTTP Endpoint 8080)  |   |
|  +----------------------------+  +------------------------+   |
|                                                               |
|  +----------------------------+  +------------------------+   |
|  |    npm パッケージ          |  |    環境変数設定        |   |
|  |   (production/dev)        |  |   (.env / .env.dev)    |   |
|  +----------------------------+  +------------------------+   |
|                                                               |
+-------------------------+---------------------------------------+
                          |
    +-------------------+-v-----------------------+
    |              Docker ボリューム                |
    |   +-------------+  +-------------+         |
    |   | config-volume |  | build-volume |      |
    |   | (設定ファイル)  |  | (ビルド成果物) |      |
    |   +-------------+  +-------------+         |
    |                                            |
    |   +-------------+                          |
    |   | logs-volume  |                         |
    |   | (ログファイル) |                         |
    |   +-------------+                          |
    +--------------------------------------------+
```

## マルチ環境設計

| 環境       | 構成ファイル             | 環境変数     | コンテナ名             | ボリューム接頭辞      |
|-----------|------------------------|------------|---------------------|-------------------|
| 開発環境    | `docker-compose.dev.yml` | `.env.dev` | `trello-discord-bot-dev` | `-dev` |
| 本番環境    | `docker-compose.yml`    | `.env`     | `trello-discord-bot`     | なし    |

### 環境分離のポイント

- **開発環境**: ホストのソースコードをマウント（ライブリロード対応）、`ts-node-dev` による実行
- **本番環境**: マルチステージビルドによるイメージ最適化、コンパイル済みJSファイル実行
- **共通設定**: ヘルスチェック統一、ボリューム永続化、非rootユーザー実行

## セキュリティ設計

- 環境変数による機密情報管理
- Docker ボリュームによる設定永続化
- エラー処理とログ記録
- リトライメカニズム
